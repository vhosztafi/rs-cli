#!/bin/bash
# Commit-msg hook to validate conventional commit messages

commit_msg_file="$1"

if [ -z "$commit_msg_file" ]; then
    echo "❌ Error: Commit message file path not provided"
    exit 1
fi

if [ ! -f "$commit_msg_file" ]; then
    echo "❌ Error: Commit message file not found: $commit_msg_file"
    exit 1
fi

commit_msg=$(cat "$commit_msg_file" | sed 's/[[:space:]]*$//')

if [ -z "$commit_msg" ]; then
    echo "❌ Error: Commit message is empty"
    exit 1
fi

conventional_pattern='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'
merge_pattern='^Merge .+'
revert_pattern='^Revert .+'

if echo "$commit_msg" | grep -qE "$conventional_pattern"; then
    exit 0
fi

if echo "$commit_msg" | grep -qE "$merge_pattern"; then
    exit 0
fi

if echo "$commit_msg" | grep -qE "$revert_pattern"; then
    exit 0
fi

echo "❌ Invalid commit message format!"
echo ""
echo "Commit messages must follow the Conventional Commits specification:"
echo "  type(scope): subject"
echo ""
echo "Allowed types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
echo ""
echo "Examples:"
echo "  feat: add new feature"
echo "  fix(core): resolve bug in parsing"
echo "  docs: update README"
echo "  chore: update dependencies"
echo ""
echo "Your message:"
echo "  $commit_msg"
echo ""
exit 1